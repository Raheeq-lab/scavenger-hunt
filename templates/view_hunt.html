<!DOCTYPE html>
<html>

<head>
    <title>Manage Hunt - {{ hunt.name }}</title>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #2E7D32;
            --secondary: #2196F3;
            --accent: #FF9800;
            --bg: #f5f7fa;
            --text: #333;
            --text-light: #666;
            --card-bg: #ffffff;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
            padding-bottom: 100px;
        }

        .breadcrumb {
            margin-bottom: 20px;
        }

        .breadcrumb a {
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .breadcrumb a:hover {
            color: var(--primary);
        }

        /* Hunt Header Card */
        .hunt-header {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            border-top: 5px solid var(--primary);
        }

        .hunt-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hunt-title {
            font-size: 2rem;
            font-weight: 800;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-pill {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .active {
            background: #e8f5e9;
            color: #2E7D32;
        }

        .inactive {
            background: #ffebee;
            color: #c62828;
        }

        .hunt-description {
            color: var(--text-light);
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
            font-weight: bold;
        }

        /* Grouping by Station */
        .station-card {
            background: white;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid #eee;
        }

        .station-header {
            background: #f8fafc;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f5f9;
        }

        .station-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .station-badge {
            background: var(--secondary);
            color: white;
            padding: 5px 15px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.9rem;
        }

        .station-name {
            font-weight: 700;
            color: #334155;
            font-size: 1.2rem;
        }

        .station-actions {
            display: flex;
            gap: 15px;
        }

        /* Question Rows */
        .question-list {}

        .question-row {
            padding: 25px 30px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.2s;
        }

        .question-row:hover {
            background: #fdfdfd;
        }

        .question-row:last-child {
            border-bottom: none;
        }

        .q-content {
            flex: 1;
        }

        .q-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .q-order {
            font-weight: 900;
            color: #94a3b8;
            font-size: 1.2rem;
            min-width: 40px;
        }

        .q-type-badge {
            background: #eff6ff;
            color: #3b82f6;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .q-points-badge {
            background: #fef3c7;
            color: #d97706;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .q-text {
            font-size: 1.1rem;
            color: #1e293b;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .q-clues {
            display: flex;
            gap: 20px;
        }

        .clue-item {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .clue-label {
            font-weight: bold;
            color: #94a3b8;
        }

        .q-actions {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 1.1rem;
        }

        .icon-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .btn-toggle-qr {
            font-size: 1.3rem;
        }

        .qr-inactive {
            opacity: 0.3;
            filter: grayscale(1);
        }

        /* QR Preview */
        .qr-preview-card {
            background: #f8fafc;
            padding: 10px;
            border-radius: 10px;
            border: 2px dashed #cbd5e1;
            text-align: center;
            min-width: 140px;
        }

        .qr-link {
            display: block;
            background: var(--primary);
            color: white;
            padding: 8px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        /* FABs */
        .fab-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 20px;
            z-index: 1000;
            border: 1px solid #eee;
        }

        .big-btn {
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 700;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-add {
            background: var(--primary);
            color: white;
        }

        .btn-add:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .btn-status {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-status:hover {
            background: #e2e8f0;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .qr-placeholder-modal {
            width: 250px;
            height: 250px;
            margin: 20px auto;
            border: 2px solid var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #fdfdfd;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 25px;
        }

        .download-btn {
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            transition: 0.2s;
        }

        .download-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="logo"><span>üéØ</span> Scavenger Hunt</div>
        <div class="nav-links">
            <a href="/teacher/dashboard" class="nav-link">Dashboard</a>
            <a href="/logout" class="nav-link">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="breadcrumb">
            <a href="/teacher/dashboard">üîô Back to Dashboard</a>
        </div>

        <!-- Hunt Overview -->
        <div class="hunt-header">
            <div class="hunt-title-row">
                <h1 class="hunt-title">
                    <span>üìã</span> {{ hunt.name }}
                    <span class="status-pill {{ 'active' if hunt.is_active else 'inactive' }}">
                        {{ 'Active' if hunt.is_active else 'Inactive' }}
                    </span>
                </h1>
                <a href="{{ url_for('edit_hunt', hunt_id=hunt.id) }}" class="icon-btn" title="Edit Hunt Settings">‚öôÔ∏è</a>
            </div>

            {% if hunt.description %}
            <p class="hunt-description">{{ hunt.description }}</p>
            {% endif %}

            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value">{{ questions|length }}</span>
                    <span class="stat-label">Questions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stationCountDisplay">0</span>
                    <span class="stat-label">QR Stations</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ hunt.created_at.strftime('%d %b') if hunt.created_at else 'New'
                        }}</span>
                    <span class="stat-label">Created</span>
                </div>
            </div>
        </div>

        <!-- Questions Grouped by Stations -->
        <div id="stationList">
            {% set ns = namespace(station_num=0) %}
            {% if questions %}
            {% for q in questions %}
            {% if q.is_new_location or loop.first %}
            {% set ns.station_num = ns.station_num + 1 %}
            {% if not loop.first %}</div>
    </div>{% endif %}

    <div class="station-card">
        <div class="station-header">
            <div class="station-info">
                <div class="station-badge">STATION {{ ns.station_num }}</div>
                <div class="station-name">QR Location {{ ns.station_num }}</div>
            </div>
            <div class="qr-preview-card">
                <div style="font-size: 1.5rem;">üì∏</div>
                <button onclick="showQRModal('{{ q.qr_url }}', '{{ ns.station_num }}')" class="qr-link"
                    style="border:none; width:100%; cursor:pointer;">SHOW QR CODE</button>
            </div>
        </div>
        <div class="question-list">
            {% endif %}

            <div class="question-row">
                <div class="q-order">{{ loop.index }}</div>
                <div class="q-content">
                    <div class="q-meta">
                        <span class="q-type-badge">{{ q.question_type.replace('-', ' ') }}</span>
                        <span class="q-points-badge">üíé {{ q.points }} pts</span>
                        {% if not q.is_new_location and not loop.first %}
                        <span style="font-size: 0.7rem; color: #94a3b8; font-weight: bold;">üîó LINKED TO STATION {{
                            ns.station_num }}</span>
                        {% endif %}
                    </div>
                    <div class="q-text">{{ q.text }}</div>
                    <div class="q-clues">
                        <div class="clue-item">
                            <span class="clue-label">Wrong Answer:</span> {{ q.hint or '(No hint)' }}
                        </div>
                        <div class="clue-item">
                            <span class="clue-label">Next Location:</span> {{ q.next_location_hint or '(No clue)' }}
                        </div>
                    </div>
                </div>
                <div class="q-actions">
                    <button onclick="toggleQRStatus({{ q.id }})"
                        class="icon-btn btn-toggle-qr {{ 'qr-active' if q.is_new_location else 'qr-inactive' }}"
                        title="{{ 'Has its own QR code' if q.is_new_location else 'Click to make this a new QR station' }}">
                        üì∏
                    </button>
                    <a href="{{ url_for('edit_question', question_id=q.id) }}" class="icon-btn"
                        title="Edit Question">‚úèÔ∏è</a>
                </div>
            </div>

            {% if loop.last %}
        </div>
    </div>{% endif %}
    {% endfor %}
    {% else %}
    <div
        style="text-align: center; padding: 100px 0; background: white; border-radius: 15px; box-shadow: var(--shadow);">
        <div style="font-size: 5rem; margin-bottom: 20px;">üó∫Ô∏è</div>
        <h2 style="color: #64748b;">No questions yet?</h2>
        <p style="color: #94a3b8;">Start building your adventure by adding your first station.</p>
        <a href="{{ url_for('add_question', hunt_id=hunt.id) }}" class="big-btn btn-add"
            style="margin: 30px auto; width: fit-content;">+ Create First Question</a>
    </div>
    {% endif %}
    </div>
    </div>

    <!-- Floating Actions Container -->
    <div class="fab-bar">
        <button onclick="toggleHuntActive({{ hunt.id }})" class="big-btn btn-status">
            {{ '‚õî Deactivate' if hunt.is_active else '‚úÖ Activate' }} Hunt
        </button>
        <a href="{{ url_for('add_question', hunt_id=hunt.id) }}" class="big-btn btn-add">
            ‚ûï Add Question
        </a>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal-overlay" onclick="closeQRModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeQRModal()">√ó</span>
            <div class="modal-title">QR Code for Station <span id="modalStationNum">1</span></div>
            <div class="modal-subtitle">Scan this code at the physical location to start the question.</div>

            <div class="qr-placeholder-modal" id="qrContainer">
                <!-- QR Image will be injected here -->
                <div style="font-size: 0.8rem; color: #999;">Generating QR...</div>
            </div>

            <div style="margin-top: 20px;">
                <a id="qrDownloadBtn" href="#" target="_blank" class="download-btn">
                    üì• Download QR Image
                </a>
            </div>

            <div style="margin-top: 20px;">
                <a id="qrFullPageBtn" href="#" target="_blank"
                    style="color: var(--secondary); font-size: 0.85rem; font-weight: bold;">
                    üìÑ Open Print-Friendly Page
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stationCount = document.querySelectorAll('.station-card').length;
            document.getElementById('stationCountDisplay').textContent = stationCount;
        });

        function showQRModal(url, stationNum) {
            const modal = document.getElementById('qrModal');
            const container = document.getElementById('qrContainer');
            const stationSpan = document.getElementById('modalStationNum');
            const downloadBtn = document.getElementById('qrDownloadBtn');
            const fullPageBtn = document.getElementById('qrFullPageBtn');

            stationSpan.textContent = stationNum;

            // Generate QR Image using API
            const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;
            container.innerHTML = `<img src="${qrImageUrl}" alt="QR Code" style="width: 100%; height: 100%; display: block;">`;

            // Set download and full page links
            downloadBtn.href = qrImageUrl;
            downloadBtn.download = `station-${stationNum}-qr.png`;

            // Extract token from URL for full page link
            const token = url.split('/').pop();
            fullPageBtn.href = `/qr/${token}`;

            modal.style.display = 'flex';
        }

        function closeQRModal(e) {
            document.getElementById('qrModal').style.display = 'none';
        }

        function toggleQRStatus(questionId) {
            fetch(`/teacher/question/${questionId}/toggle-qr`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(e => alert('Connection error'));
        }

        function toggleHuntActive(huntId) {
            fetch(`/teacher/hunt/${huntId}/toggle-active`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                })
                .catch(e => alert('Error toggling status'));
        }
    </script>
</body>

</html>